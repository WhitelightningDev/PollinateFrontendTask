<section class="space-y-6">
  <a
    routerLink="/users"
    class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 hover:text-slate-900 hover:underline"
  >
    <span aria-hidden="true">←</span>
    Back to users
  </a>

  <header class="space-y-1">
    <h2 class="text-xl font-semibold text-slate-900">
      <ng-container *ngIf="user() as u; else loadingUser">
        {{ u.name }}
      </ng-container>
      <ng-template #loadingUser>
        <span *ngIf="userLoading(); else unknownUser" class="text-slate-600">Loading user…</span>
        <ng-template #unknownUser>User</ng-template>
      </ng-template>
    </h2>

    <p class="text-sm text-slate-600" *ngIf="user() as u">
      @{{ u.username }} ·
      <a class="text-blue-700 hover:underline" [href]="'mailto:' + u.email">{{ u.email }}</a>
    </p>
  </header>

  <div
    *ngIf="userError() as err"
    class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800"
    role="alert"
  >
    {{ err }}
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    <form
      class="space-y-3 rounded-lg border border-slate-200 bg-white p-4 shadow-sm lg:col-span-1"
      [formGroup]="form"
      (ngSubmit)="addTodo()"
    >
      <div>
        <h3 class="text-base font-semibold text-slate-900">Add a to-do</h3>
        <p class="text-sm text-slate-600">Create a new item for this user.</p>
      </div>

      <label class="block text-sm font-medium text-slate-700" for="todo-title">Title</label>
      <input
        id="todo-title"
        type="text"
        formControlName="title"
        class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm outline-none focus:border-slate-900 focus:ring-2 focus:ring-slate-200"
        placeholder="e.g. Buy groceries"
      />
      <p
        *ngIf="form.controls.title.touched && form.controls.title.invalid"
        class="text-xs text-red-700"
      >
        Title is required (3–120 chars).
      </p>

      <label class="flex items-center gap-2 text-sm text-slate-700">
        <input type="checkbox" formControlName="completed" class="h-4 w-4 rounded border-slate-300" />
        Mark as completed
      </label>

      <button
        type="submit"
        class="inline-flex w-full items-center justify-center rounded-md bg-slate-900 px-3 py-2 text-sm font-medium text-white transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-60"
        [disabled]="!userId()"
      >
        Add to-do
      </button>
    </form>

    <div class="space-y-3 lg:col-span-2">
      <div
        *ngIf="(todosStatus$ | async) === 'loading'"
        class="rounded-md border border-slate-200 bg-white p-4 text-sm text-slate-700"
        role="status"
        aria-live="polite"
      >
        Loading to-dos…
      </div>

      <div
        *ngIf="(todosError$ | async) as todoErr"
        class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800"
        role="alert"
      >
        {{ todoErr }}
      </div>

      <div
        *ngIf="(todosStatus$ | async) === 'loaded' && todos().length === 0"
        class="rounded-md border border-slate-200 bg-white p-4 text-sm text-slate-700"
      >
        No to-dos for this user yet.
      </div>

      <ul *ngIf="todos().length > 0" class="space-y-2">
        <li
          *ngFor="let todo of todos(); trackBy: trackByTodoId"
          class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm"
        >
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              class="mt-1 h-4 w-4 rounded border-slate-300"
              [checked]="todo.completed"
              disabled
            />
            <div class="min-w-0">
              <div
                class="break-words text-sm font-medium text-slate-900"
                [class.line-through]="todo.completed"
                [class.text-slate-500]="todo.completed"
              >
                {{ todo.title }}
              </div>
              <div class="mt-1 text-xs text-slate-500">#{{ todo.id }}</div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</section>
